#########################
# Playbook to cleanup platform from the cluster
# Playbook arguments: complete network.yaml
#########################
- hosts: ansible_provisioners
  gather_facts: no
  tasks:
  # ----------------------------------------------------------------------

  # Cleanup all organizations' Vault indy crypto
  - name: Cleanup Vault indy crypto
    include_role:
      name: clean/vault
    vars:
      organization: "{{ organizationItem.name | lower }}"
      organization_ns: "{{ organization }}-ns"
      services: "{{ organizationItem.services }}"
      acount: "{{ organization }}-admin-vault-auth"
      vault: "{{ organizationItem.vault }}"
      role: "rw"
      auth_path: "kubernetes-{{ organization }}"
    loop: "{{ network['organizations'] }}"
    loop_control:
      loop_var: organizationItem
    when: network['type'] == 'indy'

  # Delete the Flux Helm release from all organizations's K8S clusters (including the Git secret)
  - name: Delete Flux
    include_role:
      name: clean/flux
    vars:
      kubernetes: "{{ organizationItem.k8s }}"
    loop: "{{ network['organizations'] }}"
    loop_control:
      loop_var: organizationItem
    when: network['type'] == 'indy'

  # Cleanup Flux release folder in Git for all organizations
  - name: Delete releease folder
    include_role:
      name: clean/gitops
    vars:
      release_dir: "{{playbook_dir}}/../../../{{organizationItem.gitops.release_dir}}/{{ organizationItem.name | lower }}"
      gitops: "{{ organizationItem.gitops }}"
    loop: "{{ network['organizations'] }}"
    loop_control:
      loop_var: organizationItem
    when: network['type'] == 'indy'

  # Delete all organizations' namespaces with all K8S resources (including PVCs and PVs)

  # Delete Tiller from all organizations' K8S clusters

  # Rollback all changes done on the Ansible controller (Vault client, Helm client, Kubects, AWS cli ...)