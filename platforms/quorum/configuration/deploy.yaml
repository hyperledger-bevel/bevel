# This playbook deploys a DLT network on existing Kubernetes clusters
# The Kubernetes clusters should already be created and the infomation to connect to the
#  clusters be updated in the network.yaml file that is used as an input to this playbook
###########################################################################################
# To Run this playbook from this directory, use the following command (network.yaml also in this directory)
#  ansible-playbook deploy-network.yaml -e "@./network.yaml"
############################################################################################
# Please ensure that the ../../shared/configuration playbooks have been run using the same network.yaml
- hosts: ansible_provisioners
  gather_facts: no
  tasks:  
# Generate Ambassador certifiactes for nodes
- name: "Create ambassador certificates for Nodes" 
  include_role: 
    name: create/certificates/nodes
  vars:
    root_subject: "{{ network.config.subject }}"
    cert_subject: "{{ network.config.subject | regex_replace(',', '/') }}"
    services: "{{ item.services }}"
    organisation: "{{ item.name | lower }}"
    component_ns: "{{ item.name | lower }}-ns"
    component_name: "{{ item.name | lower }}"
    kubernetes: "{{ item.k8s }}"
    vault: "{{ item.vault }}"
  loop: "{{ network['organizations']}}"
  when: network.type == 'quorum'