##############################################################################################
#  Copyright Accenture. All Rights Reserved.
#
#  SPDX-License-Identifier: Apache-2.0
##############################################################################################

---
# We have enabled additional ports on Ambassador for TCP. By default 8443 is exposed.
# The extra ports are pass as parameter --set ambassador.otherPorts={10010,10020} is taken from network.env.ambassadorPorts
- name: Format ambassador ports
  args:
    executable: /bin/bash
  shell: |
    json='{{ stewards | to_json }}'
    length=$(echo "${json}" | jq '.[] | length')
    index=0
    declare -A ports
    while [[ ${index} < ${length} ]]
    do
      steward=$( echo ${json} | jq ".[${index}]")
      name=$(echo ${steward} | jq '.name' | tr -d '"')
      node_port=$(echo ${steward} | jq '.node.ambassador' | tr -d '"')
      client_port=$(echo ${steward} | jq '.client.ambassador' | tr -d '"')
      if [[ ${name} != null ]]
      then
        if [[ ${ports["{{ kubecontext }}"]} != "" ]]
        then
          ports+=( ["{{ kubecontext }}"]+=, )
        fi
        ports+=( ["{{ kubecontext }}"]+=${node_port},${client_port} )
      fi
      index=$(( ${index} + 1 ))
    done
    echo ${ports["{{ kubecontext }}"]}
  register: terminal
  when: network['type'] == 'indy' and item.services.stewards is defined
  tags:
    - molecule-idempotence-notest

- name: Get Elastic IP
  environment:
    AWS_ACCESS_KEY_ID: "{{ aws.access_key }}"
    AWS_SECRET_ACCESS_KEY: "{{ aws.secret_key }}"
  shell: |
    # format ip addresses list to string with space separator
    ips=$(echo '{{ item.publicIps }}' | tr -d '["]' | sed 's/,/\ /g')
    data=$(aws ec2 describe-addresses --public-ips ${ips} --region {{ aws.region }} --output json | jq '.Addresses[].AllocationId')
    # format eip addresses list to string with comma separator (comma has to be escaped)
    echo ${data} | tr -d '"' | sed 's/\ /\\,/g'
  register: allocation_ips
  when: 
    - (network.type == 'indy' and item.services.stewards is defined )
    - item.cloud_provider == 'aws' or item.cloud_provider == 'aws-baremetal' #As this shell code is specific to AWS, cloud provider check has been added
  tags:
    - notest

- name: Format ambassador range
  args:
    executable: /bin/bash
  shell: |
    from='{{ network.env.ambassadorPorts.portRange.from | default('') }}'
    to='{{ network.env.ambassadorPorts.portRange.to | default('') }}'
    if [ -z "$from" ] || [ -z "$to" ] 
    then
      echo ""
    else
      echo "--set ambassador.otherPorts.portRange.from=${from} --set ambassador.otherPorts.portRange.to=${to}"
    fi
  register: ambassadorRange
  tags:
    - molecule-idempotence-notest

- name: Format ambassador ports for Corda/Besu/Quorum
  args:
    executable: /bin/bash
  shell: |
    ports=$(echo '{{ network.env.ambassadorPorts.ports | default('') }}' | sed -e 's/\[/\{/' -e 's/\]/\}/')
    if [ -z "$ports" ] 
    then
      echo ""
    else
      echo "--set ambassador.otherPorts.ports={'${ports}'}"
    fi
  register: ambassadorPorts
  when: network.type != 'indy'
  tags:
    - molecule-idempotence-notest

- name: Format ambassador ports for Indy
  args:
    executable: /bin/bash
  shell: |
    ports=$(echo '{{ network.env.ambassadorPorts.ports | default('') }}' | sed -e 's/\[/\{/' -e 's/\]/\}/')
    terminalPorts='{{ terminal.stdout | default('') }}'
    if [ -z "$ports" ] 
    then
      echo ""
    else
      echo "--set ambassador.otherPorts.ports={'${ports},${terminalPorts}'}"
    fi
  register: ambassadorPortsIndy
  when: network.type == 'indy'
  tags:
    - molecule-idempotence-notest

# Remove default selfsigned ambassador tls if already exists
- name: Remove Ambassador cred if exists
  k8s:
    kind: Secret
    namespace: default
    state: absent
    name: "ambassador-default-tls"
    kubeconfig: "{{ kubeconfig_path }}"
    context: "{{ kubecontext }}"
  tags:
    - molecule-idempotence-notest  

# Create and store selfsigned ambassador default certificate
- name: Create Ambassador default certificate
  shell: |
    mkdir -p ./build/ambassador && cd ./build/ambassador/
    openssl req -x509 -days 365 -out default_ambassador_tls.pem -keyout default_ambassador_tls.key -newkey rsa:2048 -nodes -sha256 -subj "/CN={{ item.external_url_suffix }}"
    KUBECONFIG={{ kubeconfig_path }} kubectl create secret tls ambassador-default-tls --cert="default_ambassador_tls.pem" --key="default_ambassador_tls.key" -n default
  when: 
    - network.env.external_dns is defined
    - network.env.external_dns == 'enabled'
    - fqdn is not defined
  tags:
    - molecule-idempotence-notest  

#create Ingress class for Ambassador
- name: creates IngressClass for ambassador
  k8s:
    state: present
    definition:
      apiVersion: networking.k8s.io/v1beta1
      kind: IngressClass
      metadata:
        name: ambassador
        annotations:
          ingressclass.kubernetes.io/is-default-class: "true"
      spec:
        controller: getambassador.io/ingress-controller

##Checks if cert-manager is installed 
- name: check cert-manager deployment status
  kubernetes.core.k8s_info:
    kind: Deployment
    name: cert-manager
    namespace: cert-manager
  register: certmanager
  when: fqdn is defined
  tags:
    - molecule-idempotence-notest 

##installs cert-manager if its not installed
- name: Install cert-manager
  helm:
    name: cert-manager
    namespace: cert-manager
    state: present
    chart_ref: "{{ playbook_dir }}/../../../platforms/shared/charts/cert-manager"
    create_namespace: true
  when: 
    - certmanager.resources[0].spec is not defined
    - network.env.external_dns is defined
    - network.env.external_dns == 'enabled'
    - fqdn is defined
  tags:
    -  molecule-idempotence-notest

- name: Install Ambassador with EIP for Indy
  shell: |
    KUBECONFIG={{ kubeconfig_path }} helm upgrade --install --namespace default {{ ambassadorRange.stdout }} {{ ambassadorPortsIndy.stdout }} --set ambassador.eip='{{ allocation_ips.stdout }}' --set ambassador.loadBalancerSourceRanges={"{{ network.env.loadBalancerSourceRanges | default('0.0.0.0/0') }}"} ambassador {{ playbook_dir }}/../../../platforms/shared/charts/ambassador
  when: 
    - network.type == 'indy'
    - allocation_ips.stdout is defined
  tags:
    - ambassador
    - molecule-idempotence-notest
    
- name: Install Ambassador for Corda/Quorum/Besu
  shell: |
      KUBECONFIG={{ kubeconfig_path }} helm upgrade --install --namespace default {{ ambassadorRange.stdout }} {{ ambassadorPorts.stdout }} --set ambassador.loadBalancerSourceRanges={"{{ network.env.loadBalancerSourceRanges | default('0.0.0.0/0') }}"} ambassador {{ playbook_dir }}/../../../platforms/shared/charts/ambassador
  when: network.type != 'indy'
  tags:
    - ambassador
    - molecule-idempotence-notest
  
- name: Enable external DNS
  shell: |
    KUBECONFIG={{ kubeconfig_path }} kubectl annotate service ambassador --overwrite "external-dns.alpha.kubernetes.io/hostname=*.{{ item.external_url_suffix }}."
  when: 
    - (network.type == 'indy' and allocation_ips.stdout is defined) or network.type != 'indy'
    - network.env.external_dns is defined
    - network.env.external_dns == 'enabled'
  tags:
    - ambassador
    - molecule-idempotence-notest

# Wait for Ambassador pods to start running
- name: wait for pods to come up
  include_role:
    name: "{{ playbook_dir }}/../../shared/configuration/roles/check/helm_component"
  vars:
    namespace: default
    kubeconfig: "{{ kubeconfig_path }}"
    context: "{{ kubecontext }}"
    component_name: ambassador
    component_type: "Pod"
    label_selectors: 
      - app.kubernetes.io/name=ambassador
  when: (network.type == 'indy' and allocation_ips.stdout is defined) or network.type != 'indy'

##check for an existing clusterissuer
- name: check for an existing clusterissuer
  kubernetes.core.k8s_info:
    kind: ClusterIssuer
    name: letsencrypt-prod
    namespace: default
  register: clusterissuer
  when: 
    - network.env.external_dns is defined
    - network.env.external_dns == 'enabled'
  ignore_errors: true
  tags:
    - molecule-idempotence-notest

##create clusterissuer if it is not deployed
- name: create ClusterIssuer
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: cert-manager.io/v1
      kind: ClusterIssuer
      metadata:
        name: letsencrypt-prod
        namespace: default
      spec:
        acme: 
          email: "{{ email }}"
          server: https://acme-v02.api.letsencrypt.org/directory
          privateKeySecretRef:
            name: clusterissuer-account-key
          solvers:
            - http01:
                ingress:
                  class: ambassador
  when: 
    - clusterissuer.resources[0] is not defined
    - network.env.external_dns is defined
    - network.env.external_dns == 'enabled'
    - fqdn is defined
  tags:
    - molecule-idempotence-notest

##create mapping for acme
- name: create Mapping for Acme
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: getambassador.io/v2
      kind: Mapping
      metadata:
        name: acme-challenge-mapping
        namespace: default
      spec:
        hostname: "*"
        prefix: /.well-known/acme-challenge/
        rewrite: ""
        service: acme-challenge-service
  when: 
    - network.env.external_dns is defined
    - network.env.external_dns == 'enabled'
    - fqdn is defined
  tags:
    - molecule-idempotence-notest

##create service for acme challenge
- name: create acme challenge service
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: service
      metadata:
        name: acme-challenge-service
        namespace: default
      spec:
        ports:
          - port: 80
            targetPort: 8089
        selector:
          acme.cert-manager.io/http01-solver: "true"
  when: 
    - network.env.external_dns is defined
    - network.env.external_dns == 'enabled'
    - fqdn is defined
  tags:
    - molecule-idempotence-notest

##create Ambassador default TLS certificate by cert-manager
- name: create Ambassador default tls certificate by cert-manager
  k8s:
    state: present
    definition:
      apiVersion: cert-manager.io/v1
      kind: Certificate
      metadata:
        name: ambassador-default-tls
        namespace: default
      spec:
        secretName: ambassador-default-tls
        issuerRef:
          name: letsencrypt-prod
          kind: ClusterIssuer
        duration: 8760h #365 days
        renewBefore: 168h #7 days
        isCA: false
        dnsNames:
          - "{{ fqdn }}"
  when: 
    - network.env.external_dns is defined
    - network.env.external_dns == 'enabled'
    - fqdn is defined
  tags:
    - molecule-idempotence-notest
